---
# tasks file for grafana
- name: 1.0 Ensure /etc/apt/keyrings directory exists
  file:
    path: "{{ grafana_ensure_keyrings }}"
    state: directory
    mode: '0755'
  become: true

- name: 1.1 Download and dearmor Grafana GPG key
  ansible.builtin.get_url:
    url: "{{ grafana_download_pgp }}"
    dest: "{{ grafana_dest_gpg }}"
    mode: '0644'
  become: true

- name: 1.2 Convert Grafana GPG key to binary format
  ansible.builtin.command:
    cmd: "{{ grafana_convert_gpg }}"
  args:
    creates: "{{ grafana_ensure_keyrings }}/grafana.gpg"
  become: true

- name: 1.3 Add Grafana APT repository
  ansible.builtin.apt_repository:
    repo: "{{ grafana_repo }}"
    state: present
    filename: grafana
  become: true

- name: 1.5 Install Grafana
  ansible.builtin.apt:
    name: grafana
    state: present
    update_cache: yes
  become: true

- name: 1.6 Create var/lib/grafana/dashboard directory
  ansible.builtin.file:
    path: "{{ grafana_dashboard_path }}"
    state: directory
    mode: '0755'
  become: true

- name: 1.7 Copy grafana config file and move dashboard in dir
  block: 
    - name: 1.7.1 Copy grafana config file and move dashboard in dir
      template:
        src: "templates/{{ item }}.j2"
        dest: "/{{ item }}"
        mode: '0744'
      with_items: "{{ grafana_config_file }}"

  #   - name: 1.7.2 Copy grafana config file and move dashboard in dir
  #     template:
  #       src: "templates/{{ item }}"
  #       dest: "/{{ item }}"
  #       mode: '0744'
  #     with_items: "{{ grafana_dashboard_main_dashboard_dir }}"
  # become: true

- name: 1.8 Check grafana version
  ansible.builtin.command: 
    cmd: "{{ grafana_check_version }}"
  register: grafana_version

- name: 1.9 Debug check grafana version
  debug:
    msg: "{{ grafana_version }}"

- name: 1.10 Enable grafana systemd and ensure what grafana started
  block:
    - name: 1.10.1 Reload systemd manager configuration
      ansible.builtin.systemd:
        daemon_reload: yes

    - name: 1.10.2 Enable and start Prometheus service
      ansible.builtin.systemd:
        name: grafana-server
        state: started
        enabled: yes

    - name: 1.10.3 Check grafana service start
      shell: "{{ grafana_service_status }}"
      register: grafana_status

    - name: 1.10.4 Debug check grafana service start
      debug:
        msg: "{{ grafana_status }}"
  become: true